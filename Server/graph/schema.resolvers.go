package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.55

import (
	"context"
	"fmt"

	"github.com/elc49/copod/cache"
	"github.com/elc49/copod/graph/model"
	"github.com/elc49/copod/paystack"
	sql "github.com/elc49/copod/sql/sqlc"
	"github.com/elc49/copod/util"
	"github.com/google/uuid"
	"github.com/sirupsen/logrus"
)

// ChargeMpesa is the resolver for the chargeMpesa field.
func (r *mutationResolver) ChargeMpesa(ctx context.Context, input model.PayWithMpesaInput) (*string, error) {
	charge := paystack.MpesaCharge{
		Email:    input.Email,
		Reason:   input.Reason.String(),
		Currency: input.Currency,
	}

	res, err := r.paystack.ChargeMpesa(ctx, input.PaymentFor, charge)
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"charge": charge}).Errorf("graph resolvers: ChargeMpesa")
		return nil, err
	}

	return &res.Data.Reference, nil
}

// UpdateTitleVerificationByID is the resolver for the updateTitleVerificationById field.
func (r *mutationResolver) UpdateTitleVerificationByID(ctx context.Context, input model.UpdateTitleVerificationInput) (*model.Title, error) {
	args := sql.UpdateTitleByIDParams{
		ID:           input.ID,
		Verification: input.Verification.String(),
	}

	title, err := r.titleController.UpdateTitleByID(ctx, args)
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"input": input}).Errorf("resolver: UpdateTitleByID")
		return nil, err
	}

	return title, nil
}

// CreateUser is the resolver for the createUser field.
func (r *mutationResolver) CreateUser(ctx context.Context, input model.CreateUserInput) (*model.User, error) {
	args := sql.CreateUserParams{
		Email:     input.Email,
		Firstname: input.Firstname,
		Lastname:  input.Lastname,
	}
	u, err := r.userController.CreateUser(ctx, args)
	if err != nil {
		return nil, err
	}

	uargs := sql.UpdateSupportDocByIDParams{
		ID:           input.SupportDocID,
		Verification: input.Verification.String(),
	}
	if _, err = r.supportDocController.UpdateSupportDocByID(ctx, uargs); err != nil {
		return nil, err
	}

	return u, err
}

// CreateOnboarding is the resolver for the createOnboarding field.
func (r *mutationResolver) CreateOnboarding(ctx context.Context, input model.CreateOnboardingInput) (*model.Onboarding, error) {
	return r.onboardingController.CreateOnboarding(ctx, input)
}

// UpdateOnboardingStatus is the resolver for the updateOnboardingStatus field.
func (r *mutationResolver) UpdateOnboardingStatus(ctx context.Context, input model.UpdateOnboardingStatusInput) (*model.Onboarding, error) {
	panic(fmt.Errorf("not implemented: UpdateOnboardingStatus - updateOnboardingStatus"))
}

// GetUserLands is the resolver for the getUserLands field.
func (r *queryResolver) GetUserLands(ctx context.Context, email string) ([]*model.Title, error) {
	lands, err := r.titleController.GetTitlesByEmail(ctx, email)
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"email": email}).Errorf("resolver: GetUserLands")
		return nil, err
	}

	return lands, nil
}

// GetPaymentsByStatus is the resolver for the getPaymentsByStatus field.
func (r *queryResolver) GetPaymentsByStatus(ctx context.Context, status model.PaymentStatus) ([]*model.Payment, error) {
	payments, err := r.paymentController.GetPaymentsByStatus(ctx, status.String())
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"status": status.String()}).Errorf("resolver: GetPaymentsByStatus")
		return nil, err
	}

	return payments, nil
}

// GetPaymentDetailsByID is the resolver for the getPaymentDetailsById field.
func (r *queryResolver) GetPaymentDetailsByID(ctx context.Context, id uuid.UUID) (*model.Payment, error) {
	payment, err := r.paymentController.GetPaymentDetailsByID(ctx, id)
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"id": id}).Errorf("resolver: GetPaymentDetailsByID")
		return nil, err
	}

	return payment, nil
}

// GetSupportingDocsByVerification is the resolver for the getSupportingDocsByVerification field.
func (r *queryResolver) GetSupportingDocsByVerification(ctx context.Context, verification model.Verification) ([]*model.SupportingDoc, error) {
	docs, err := r.supportDocController.GetSupportingDocsByVerification(ctx, verification)
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"verification": verification}).Errorf("resolver: GetSupportingDocsByVerification")
		return nil, err
	}

	return docs, nil
}

// GetSupportingDocByID is the resolver for the getSupportingDocById field.
func (r *queryResolver) GetSupportingDocByID(ctx context.Context, id uuid.UUID) (*model.SupportingDoc, error) {
	doc, err := r.supportDocController.GetSupportingDocByID(ctx, id)
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"id": id}).Errorf("resolver: GetSupportingDocByID")
		return nil, err
	}

	return doc, nil
}

// GetOnboardingByVerification is the resolver for the getOnboardingByVerification field.
func (r *queryResolver) GetOnboardingByVerification(ctx context.Context, verification model.Verification) ([]*model.Onboarding, error) {
	panic(fmt.Errorf("not implemented: GetOnboardingByVerification - getOnboardingByVerification"))
}

// PaymentUpdate is the resolver for the paymentUpdate field.
func (r *subscriptionResolver) PaymentUpdate(ctx context.Context, email string) (<-chan *model.PaymentUpdate, error) {
	ch := make(chan *model.PaymentUpdate)
	pubsub := r.redis.Subscribe(context.Background(), cache.PAYMENT_UPDATED_CHANNEL)

	go func() {
		for msg := range pubsub.Channel() {
			var result *model.PaymentUpdate
			if err := util.DecodeJson([]byte(msg.Payload), &result); err != nil {
				r.log.WithError(err).WithFields(logrus.Fields{"payload": msg.Payload}).Errorf("resolvers: DecodeJson msg.Payload")
				return
			}

			if result.Email == email {
				ch <- result
			}
		}
	}()

	return ch, nil
}

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Query returns QueryResolver implementation.
func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

// Subscription returns SubscriptionResolver implementation.
func (r *Resolver) Subscription() SubscriptionResolver { return &subscriptionResolver{r} }

type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
type subscriptionResolver struct{ *Resolver }

// !!! WARNING !!!
// The code below was going to be deleted when updating resolvers. It has been copied here so you have
// one last chance to move it out of harms way if you want. There are two reasons this happens:
//  - When renaming or deleting a resolver the old code will be put in here. You can safely delete
//    it when you're done.
//  - You have helper methods in this file. Move them out to keep these resolver files clean.
/*
	func (r *paymentResolver) Title(ctx context.Context, obj *model.Payment) (*model.Title, error) {
	onboarding, err := r.paymentController.GetPaymentOnboardingByID(ctx, obj.OnboardingID)
	if err != nil {
		r.log.WithError(err).WithFields(logrus.Fields{"title_id": obj.OnboardingID}).Errorf("resolver: Title for payment")
		return nil, err
	}

	return onboarding, nil
}
func (r *Resolver) Payment() PaymentResolver { return &paymentResolver{r} }
type paymentResolver struct{ *Resolver }
*/
